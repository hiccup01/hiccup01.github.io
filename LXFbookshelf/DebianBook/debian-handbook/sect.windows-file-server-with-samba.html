<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>11.5. Setting Up Windows Shares with Samba</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 3.0" /><meta name="package" content="Debian-debian-handbook-6.0-en-US-1.0-1" /><meta name="keywords" content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link rel="home" href="index.html" title="The Debian Administrator's Handbook" /><link rel="up" href="network-services.html" title="Chapter 11. Network Services: Postfix, Apache, NFS, Samba, Squid, LDAP" /><link rel="prev" href="sect.nfs-file-server.html" title="11.4. NFS File Server" /><link rel="next" href="sect.http-ftp-proxy.html" title="11.6. HTTP/FTP Proxy" /></head><body><p class="hidden" id="title"><a class="left" href="http://www.debian.org"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="http://debian-handbook.info"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="sect.nfs-file-server.html"><strong>Prev</strong></a></li><li class="home">The Debian Administrator's Handbook</li><li class="next"><a accesskey="n" href="sect.http-ftp-proxy.html"><strong>Next</strong></a></li></ul><div class="section"><div class="titlepage"><div><div><h2 class="title" id="sect.windows-file-server-with-samba">11.5. Setting Up Windows Shares with Samba</h2></div></div></div><div class="para"><p></p>
			Samba is a suite of tools handling the SMB protocol (now called “CIFS”) on Linux. This protocol is used by Windows for network shares and shared printers.
		</div><a id="idp9425032" class="indexterm"></a><a id="idp9425496" class="indexterm"></a><a id="idp9425976" class="indexterm"></a><a id="idp9426456" class="indexterm"></a><a id="idp9426936" class="indexterm"></a><div class="para"><p></p>
			Samba can also act as an NT domain controller. This is an outstanding tool for ensuring seamless integration of Linux servers and the office desktop machines still running Windows.
		</div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="idp9428072">11.5.1. Samba Server</h3></div></div></div><div class="para"><p></p>
				The <span class="pkg pkg">samba</span> package contains the main two servers of Samba 3, <code class="command">smbd</code> and <code class="command">nmbd</code>.
			</div><a id="idp9429616" class="indexterm"></a><a id="idp9430176" class="indexterm"></a><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>TOOL</em></span> Administrating Samba with SWAT</h6></div></div></div><div class="para"><p></p>
				SWAT (<span class="emphasis"><em>Samba Web Administration Tool</em></span>) is a web interface that allows configuring the Samba service. Since the <span class="pkg pkg">swat</span> package does not enable its configuration interface by default, it must be enabled manually with <code class="command">update-inetd --enable swat</code>.
			</div><a id="idp9432552" class="indexterm"></a><div class="para"><p></p>
				<span class="emphasis"><em>SWAT</em></span> then becomes available at the <code class="literal">http://localhost:901</code> URL. Accessing it means using the root account (and its usual password). Note that SWAT rewrites the <code class="filename">smb.conf</code> in its own idiom, so it makes sense to make a backup copy beforehand if you're only interested in testing this tool.
			</div><div class="para"><p></p>
				SWAT is very user-friendly; its interface includes an assistant that allows defining the server's role in three questions. All global options can still be configured, as well as those for all the existing shares, and of course new shares can be added. Each option comes with a link to the relevant documentation.
			</div></div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>DOCUMENTATION</em></span> Going further</h6></div></div></div><div class="para"><p></p>
				The Samba server is extremely configurable and versatile, and can address a great many different use cases matching very different requirements and network architectures. This book only focuses on the use case where Samba is used as main domain controller, but it can also be a simple server on the domain and delegate authentication to the main controller (which could be a Windows server).
			</div><a id="idp9436000" class="indexterm"></a><a id="idp9436464" class="indexterm"></a><div class="para"><p></p>
				The documentation available in the <span class="pkg pkg">samba-doc</span> package is very well written. In particular, the <em class="citetitle"><span class="foreignphrase"><em class="foreignphrase">Samba 3 By Example</em></span></em> document (available as <code class="filename">/usr/share/doc/samba-doc/htmldocs/Samba3-ByExample/index.html</code>) deals with a concrete use case that evolves alongside the growing company.
			</div></div><div class="sidebar fil"><div class="titlepage"><div><div><h6><span class="emphasis"><em>TOOL</em></span> Authenticating with a Windows Server</h6></div></div></div><div class="para"><p></p>
				Winbind gives system administrators the option of using a Windows NT server as an authentication server. Winbind also integrates cleanly with PAM and NSS. This allows setting up Linux machines where all users of an NT domain automatically get an account.
			</div><a id="idp9439608" class="indexterm"></a><div class="para"><p></p>
				More information can be found in the <code class="filename">/usr/share/doc/samba-doc/htmldocs/Samba3-HOWTO/winbind.html</code> file.
			</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title" id="idp9440728">11.5.1.1. Configuring with <code class="command">debconf</code></h4></div></div></div><div class="para"><p></p>
					The package sets up a minimal configuration based on the answers to a few Debconf questions asked during the initial installation; this configuration step can be replayed later with <code class="command">dpkg-reconfigure samba-common samba</code>.
				</div><div class="para"><p></p>
					The first piece of required information is the name of the workgroup where the Samba server will belong (the answer is <code class="literal">FALCOTNET</code> in our case). Another question asks whether passwords should be encrypted. The answer is that they should, because it's a requirement for the most recent Windows clients; besides, this increases security. The counterpart is that this required managing Samba passwords separately from the Unix passwords.
				</div><div class="para"><p></p>
					The package also proposes identifying the WINS server from the information provided by the DHCP daemon. The Falcot Corp administrators rejected this option, since they intend to use the Samba server itself as the WINS server.
				</div><a id="idp9443336" class="indexterm"></a><div class="para"><p></p>
					The next question is about whether servers should be started by <code class="command">inetd</code> or as stand-alone daemons. Using <code class="command">inetd</code> is only interesting when Samba is rarely used; the Falcot administrators therefore picked stand-alone daemons.
				</div><div class="para"><p></p>
					Finally, the package proposes creating a <code class="filename">/var/lib/samba/passdb.tdb</code> file for storing encrypted passwords; this option was accepted, since this system is much more efficient than the standard <code class="filename">/etc/samba/smbpasswd</code> text file.
				</div><a id="idp9445568" class="indexterm"></a><a id="idp9446128" class="indexterm"></a></div><div class="section"><div class="titlepage"><div><div><h4 class="title" id="idp9446752">11.5.1.2. Configuring Manually</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title" id="idp9447136">11.5.1.2.1. Changes to <code class="filename">smb.conf</code></h5></div></div></div><div class="para"><p></p>
						The requirements at Falcot require other options to be modified in the <code class="filename">/etc/samba/smb.conf</code> configuration file. The following excerpts summarize the changes that were effected in the <code class="literal">[global]</code> section.
					</div><pre class="programlisting">
[global]

## Browsing/Identification ###

# Change this to the workgroup/NT-domain name your Samba server will part of
   workgroup = FALCOTNET

# server string is the equivalent of the NT Description field
   server string = %h server (Samba %v)

# Windows Internet Name Serving Support Section:
# WINS Support - Tells the NMBD component of Samba to enable its WINS Server
   wins support = yes <img class="callout" src="Common_Content/images/1.png" alt="1" border="0" id="smb.conf.wins" />

[...]

####### Authentication #######

# "security = user" is always a good idea. This will require a Unix account
# in this server for every user accessing the server. See
# /usr/share/doc/samba-doc/htmldocs/Samba3-HOWTO/ServerType.html 
# in the samba-doc package for details.
   security = user <img class="callout" src="Common_Content/images/2.png" alt="2" border="0" id="smb.conf.security" />

# You may wish to use password encryption.  See the section on
# 'encrypt passwords' in the smb.conf(5) manpage before enabling.
   encrypt passwords = true

# If you are using encrypted passwords, Samba will need to know what
# password database type you are using.
   passdb backend = tdbsam guest

[...]

########## Printing ##########

# If you want to automatically load your printer list rather
# than setting them up individually then you'll need this
   load printers = yes <img class="callout" src="Common_Content/images/3.png" alt="3" border="0" id="smb.conf.loadprinters" />

# lpr(ng) printing. You may wish to override the location of the
# printcap file
;   printing = bsd
;   printcap name = /etc/printcap

# CUPS printing.  See also the cupsaddsmb(8) manpage in the
# cups-client package.
   printing = cups <img class="callout" src="Common_Content/images/4.png" alt="4" border="0" id="smb.conf.printing" />
   printcap name = cups
   
[...]

######## File sharing ########

# Name mangling options
;   preserve case = yes
;   short preserve case = yes

unix charset=ISO8859-1 <img class="callout" src="Common_Content/images/5.png" alt="5" border="0" id="smb.conf.charset" /></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#smb.conf.wins"><img class="callout" src="Common_Content/images/1.png" alt="1" border="0" id="smb.conf.wins" /></a> </p></td><td valign="top" align="left"><div class="para"><p></p>
								Indicates that Samba should act as a Netbios name server (WINS) for the local network.
							</div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#smb.conf.security"><img class="callout" src="Common_Content/images/2.png" alt="2" border="0" id="smb.conf.security" /></a> </p></td><td valign="top" align="left"><div class="para"><p></p>
								This is the default value for this parameter; however, since it is central to the Samba configuration, filling it explicitly is recommended. Each user must authenticate before accessing any share.
							</div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#smb.conf.loadprinters"><img class="callout" src="Common_Content/images/3.png" alt="3" border="0" id="smb.conf.loadprinters" /></a> </p></td><td valign="top" align="left"><div class="para"><p></p>
								Tells Samba to automatically share all local printers that exist in the CUPS configuration. Restricting access to these printers is still possible, by adding appropriate sections.
							</div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#smb.conf.printing"><img class="callout" src="Common_Content/images/4.png" alt="4" border="0" id="smb.conf.printing" /></a> </p></td><td valign="top" align="left"><div class="para"><p></p>
								Specifies the printing system in use; in our case, CUPS.
							</div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#smb.conf.charset"><img class="callout" src="Common_Content/images/5.png" alt="5" border="0" id="smb.conf.charset" /></a> </p></td><td valign="top" align="left"><div class="para"><p></p>
								Specifies the character set and encoding used for file names under Linux. The default value is UTF8 (Unicode).
							</div></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title" id="idp9455808">11.5.1.2.2. Adding Users</h5></div></div></div><div class="para"><p></p>
						Each Samba user needs an account on the server; the Unix accounts must be created first, then the user needs to be registered in Samba's database. The Unix step is done quite normally (using <code class="command">adduser</code> for instance).
					</div><div class="para"><p></p>
						Adding an existing user to the Samba database is a matter of running the <code class="command">smbpasswd -a <em class="replaceable"><code>user</code></em></code> command; this command asks for the password interactively.
					</div><div class="para"><p></p>
						A user can be deleted with the <code class="command">smbpasswd -x <em class="replaceable"><code>user</code></em></code> command. A Samba account can also be temporarily disabled (with <code class="command">smbpasswd -d <em class="replaceable"><code>user</code></em></code>) and re-enabled later (with <code class="command">smbpasswd -e <em class="replaceable"><code>user</code></em></code>).
					</div></div><div class="section"><div class="titlepage"><div><div><h5 class="title" id="idp9459184">11.5.1.2.3. Switching to Domain Controller</h5></div></div></div><div class="para"><p></p>
						This section documents how the Falcot administrators went even further, by turning the Samba server into a domain controller providing roaming profiles (which allow users to find their desktop no matter what machine they connect to).
					</div><a id="idp9460088" class="indexterm"></a><a id="idp9460552" class="indexterm"></a><div class="para"><p></p>
						They first added a few extra directives in the <code class="literal">[global]</code> section of the configuration file:
					</div><pre class="programlisting">
domain logons = yes              <img class="callout" src="Common_Content/images/1.png" alt="1" border="0" id="smb.conf.domainlogons" />
preferred master = yes           
logon path = \\%L\profiles\%U    <img class="callout" src="Common_Content/images/2.png" alt="2" border="0" id="smb.conf.logonpath" />
logon script = scripts/logon.bat <img class="callout" src="Common_Content/images/3.png" alt="3" border="0" id="smb.conf.logonscript" /></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#smb.conf.domainlogons"><img class="callout" src="Common_Content/images/1.png" alt="1" border="0" id="smb.conf.domainlogons" /></a> </p></td><td valign="top" align="left"><div class="para"><p></p>
								Enables the domain controller functionality.
							</div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#smb.conf.logonpath"><img class="callout" src="Common_Content/images/2.png" alt="2" border="0" id="smb.conf.logonpath" /></a> </p></td><td valign="top" align="left"><div class="para"><p></p>
								Specifies the location of the users' home directories. These are stored on a dedicated share, which allows enabling specific options (in particular, <code class="literal">profile acls</code>, a requirement for compatibility with Windows 2000, XP and Vista).
							</div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#smb.conf.logonscript"><img class="callout" src="Common_Content/images/3.png" alt="3" border="0" id="smb.conf.logonscript" /></a> </p></td><td valign="top" align="left"><div class="para"><p></p>
								Specifies the <span class="emphasis"><em>batch</em></span> (non-interactive) script that is to be run on the client Windows machine every time a session is opened. In this case, <code class="filename">/var/lib/samba/netlogon/scripts/logon.bat</code>. The script needs to be in DOS format, where the lines are separated by a carriage-return character and a line-feed character; if the file was created on Linux, running <code class="command">unix2dos</code> will convert it.
							</div><div class="para"><p></p>
								The commands used most widely in these scripts allow the automatic creation of network drives and synchronizing the system time.
							</div><div class="example"><h6>Example 11.28. The <code class="filename">logon.bat</code> file</h6><div class="example-contents"><pre class="programlisting">
net time \\ARRAKIS /set /yes
net use H: /home
net use U: \\ARRAKIS\utils
</pre></div></div><br class="example-break" /></td></tr></table></div><div class="para"><p></p>
						Two extra shares, and their associated directories, were also created:
					</div><pre class="programlisting">
[netlogon]
comment = Network Logon Service
path = /var/lib/samba/netlogon
guest ok = yes
writable = no
share modes = no

[profiles]
comment = Profile Share
path = /var/lib/samba/profiles
read only = No
profile acls = Yes
</pre><div class="para"><p></p>
						The home directories for all users must also be created (as <code class="filename">/var/lib/samba/profiles/<em class="replaceable"><code>user</code></em></code>), and each of them must be owned by the matching user.
					</div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="idp11917256">11.5.2. Samba Client</h3></div></div></div><div class="para"><p></p>
				The client features in Samba allow a Linux machine to access Windows shares and shared printers. The required programs are available in the <span class="pkg pkg">smbfs</span> and <span class="pkg pkg">smbclient</span> packages.
			</div><a id="idp11918784" class="indexterm"></a><a id="idp11919344" class="indexterm"></a><div class="section"><div class="titlepage"><div><div><h4 class="title" id="idp11919904">11.5.2.1. The <code class="command">smbclient</code> Program</h4></div></div></div><div class="para"><p></p>
					The <code class="command">smbclient</code> program queries SMB servers. It accepts a <code class="literal">-U <em class="replaceable"><code>user</code></em></code> option, for connecting to the server under a specific identity. <code class="command">smbclient //<em class="replaceable"><code>server</code></em>/<em class="replaceable"><code>share</code></em></code> accesses the share in an interactive way similar to the command-line FTP client. <code class="command">smbclient -L <em class="replaceable"><code>server</code></em></code> lists all available (and visible) shares on a server.
				</div></div><div class="section"><div class="titlepage"><div><div><h4 class="title" id="idp11922720">11.5.2.2. Mounting Windows Shares</h4></div></div></div><div class="para"><p></p>
					The <code class="command">smbmount</code> command allows mounting a Windows share into the Linux filesystem hierarchy.
				</div><a id="idp11923656" class="indexterm"></a><div class="example"><h6>Example 11.29. Mounting a Windows share</h6><div class="example-contents"><pre class="programlisting">
smbmount //arrakis/shared /shared -o credentials=/usr/local/etc/smb-credentials
</pre></div></div><br class="example-break" /><div class="para"><p></p>
					The <code class="filename">/usr/local/etc/smb-credentials</code> file (which must not be readable by users) has the following format:
				</div><pre class="programlisting">
username = <em class="replaceable"><code>user</code></em>
password = <em class="replaceable"><code>password</code></em></pre><div class="para"><p></p>
					Other options can be specified on the command-line; their full list is available in the <span class="citerefentry"><span class="refentrytitle">smbmount</span>(1)</span> manual page. Two options in particular can be interesting: <code class="literal">uid</code> and <code class="literal">gid</code> allow forcing the owner and group of files available on the mount, so as not to restrict access to root.
				</div><div class="para"><p></p>
					The <code class="command">smbumount</code> command unmounts an SMB share.
				</div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>ALTERNATIVE</em></span> Using <code class="command">mount</code> for a Windows share</h6></div></div></div><div class="para"><p></p>
					The <code class="command">mount</code> command itself does not handle CIFS; however, when asked to mount an unknown filesystem type, it tries delegating the task to a <code class="command">mount.<em class="replaceable"><code>type</code></em></code>. Since the <span class="pkg pkg">smbfs</span> package does provide a <code class="command">mount.cifs</code> command, it then becomes possible to mount a Windows share with the standard <code class="command">mount</code> command:
				</div><pre class="programlisting">
mount -t cifs -o credentials=/usr/local/etc/smb-credentials //<em class="replaceable"><code>server</code></em>/shared /shared
</pre><div class="para"><p></p>
					This also allows configuring an SMB mount in the standard <code class="filename">/etc/fstab</code> file:
				</div><pre class="programlisting">
//<em class="replaceable"><code>server</code></em>/shared /shared cifs credentials=/usr/local/etc/smb-credentials
</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title" id="idp11932544">11.5.2.3. Printing on a Shared Printer</h4></div></div></div><div class="para"><p></p>
					CUPS is an elegant solution for printing from a Linux workstation to a printer shared by a Windows machine. When the <span class="pkg pkg">smbclient</span> is installed, CUPS allows installing Windows shared printers automatically.
				</div><a id="idp11933784" class="indexterm"></a><div class="para"><p></p>
					Here are the required steps:
				</div><div class="itemizedlist"><ul><li class="listitem"><div class="para"><p></p>
							Enter the CUPS configuration interface:
						</div><div class="para"><p></p>
							<code class="literal">http://localhost:631/admin</code>.
						</div></li><li class="listitem"><div class="para"><p></p>
							Click on “Add Printer”, then enter the data relevant to this printer.
						</div></li><li class="listitem"><div class="para"><p></p>
							When choosing the printer device, pick “Windows Printer via SAMBA”.
						</div></li><li class="listitem"><div class="para"><p></p>
							The URI describing the printer looks like the following:
						</div><div class="para"><p></p>
							<code class="literal">smb://<em class="replaceable"><code>user</code></em>:<em class="replaceable"><code>password</code></em>@<em class="replaceable"><code>server</code></em>/<em class="replaceable"><code>printer</code></em></code>.
						</div></li></ul></div><div class="para"><p></p>
					Voilà, the printer is operational!
				</div></div></div></div><div id="site_footer"></div><script type="text/javascript">
		$("#site_footer").load("../../../../../footer.html");
	</script><ul class="docnav"><li class="previous"><a accesskey="p" href="sect.nfs-file-server.html"><strong>Prev</strong>11.4. NFS File Server</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="sect.http-ftp-proxy.html"><strong>Next</strong>11.6. HTTP/FTP Proxy</a></li></ul></body></html>
